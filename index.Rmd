---
title: "Procedimentos metodológicos - Sebrae Goiás"
author: "Daniel Pagotto"
date: "09/08/2021"
output: html_document
---

```{r preparacao, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse); library(vroom); library(genderBR); library(readxl); library(lubridate)

tab_cnae <- read_delim("https://raw.githubusercontent.com/danielppagotto/Sebrae-go-mulheres/main/bases%20de%20apoio/cnae.csv",
                       ",", escape_double = FALSE, trim_ws = TRUE, locale = locale(encoding = "windows-1252"))

municipios <- read_delim("https://raw.githubusercontent.com/danielppagotto/Sebrae-go-mulheres/main/bases%20de%20apoio/municipios_serpro.csv",
                         ";", escape_double = FALSE, trim_ws = TRUE, locale = locale(encoding = "windows-1252"))


natureza_juridica <- read_delim("https://raw.githubusercontent.com/danielppagotto/Sebrae-go-mulheres/main/bases%20de%20apoio/natureza_juridica.csv",
                                ",", escape_double = FALSE, trim_ws = TRUE, locale = locale(encoding = "windows-1252")) 



# Subindo bases depois de tratatadas -------------------------------------------

setwd("~/LAPEI/Projeto SEBRAE/Atualização pesquisas/empreendedorismo RFB/empresas")

ativas_base <- vroom("~/LAPEI/Projeto SEBRAE/Atualização pesquisas/empreendedorismo RFB/empresas/empresas_ativas.csv")

ativas <- ativas_base %>% 
  rename(razao_social = X2, natureza_juridica = X3, 
         qualifica_responsavel = X4, capital_social = X5,
         porte_empresa = X6, ente_federativo = X7) %>% 
         left_join(natureza_juridica, by = c("natureza_juridica" = "cod_subclass_natureza_juridica")) %>% 
         filter(cod_natureza_juridica > 1 & cod_natureza_juridica < 5) %>% 
         rename(id = `...1`)

setwd("~/LAPEI/Projeto SEBRAE/Atualização pesquisas/empreendedorismo RFB/empresas")
socios <- vroom("socios.csv")
```

## Tratamentos iniciais

Os dados receberam um tratamento inicial, que consistiu nos seguintes procedimentos: 1) manutenção de empresas com status ativo; 2) retirada de empresas com natureza jurídica pública ou associada a organismos internacionais (tal procedimento foi diferente do que fizemos no relatório passado). 

As informações a seguir representa a estrutura da base estabelecimentos, que é a parte central dos dados da Receita Federal Brasileira (RFB). Ao todo, registramos 684.096 de empresas ativas no estado de Goiás. 

```{r base}

glimpse(ativas)

```

## 1) Análise Microempresa 

Optamos por filtrar as observações correspondentes a microempresas primeiro, pois são mais volumosas e mais fáceis de tratar. Ao todo, das 684.096 empresas, 426.014 foram microempresas (62,7%)

```{r}
microempresas <- ativas %>% 
        filter(natureza_juridica == "2135") 

dim(microempresas)
```

Em sequência, aplicou-se a função `get_gender` para identificar nomes dos empresários. O algoritmo conseguiu prever 90% dos nomes. Com isso, o número de observações foi de 387.345.

```{r}

me <- microempresas %>% 
  mutate(genero = get_gender(razao_social), .after = razao_social) %>% 
  filter(genero != "NA") %>% 
  left_join(municipios, by = c("municipio"="Codigo_TOM_SERPRO")) %>% 
  mutate(data = parse_date_time(data_inicio_atividade, orders = "ymd"),
         ano = year(data)) 

dim(me)

```

Por fim, foi feito um agrupamento por microempresas por município 

```{r}
municipios_me <- me %>% 
  rename(nome_municipio = Municipio) %>% 
  group_by(municipio, nome_municipio , genero) %>% 
  count() %>% 
  mutate(natureza = "me")

DT::datatable(municipios_me)
```

## 2) Análise das demais naturezas jurídicas 

Ao todo o estado possui 258.082 empresas das demais naturezas jurídicas. 

```{r}
nao_me1 <- ativas %>% 
  filter(natureza_juridica != "2135") 

dim(nao_me1)
```

Nesse caso, as empresas possuem sócios. Juntando as bases de empresas e sócios ficamos com 536.738 observações. Isso indica que cada empresa tem em média 2,07 sócios. 

Porém, fizemos um tratamento para manter apenas os sócios que estavam no momento da fundação da empresa e que permaneciam como sócio. Com isso, ficamos com 234.101 observações

```{r}
nao_me <- nao_me1 %>% 
        left_join(socios, by = c("cnpj_basico"="cnpj_basico")) 

nao_me_tratado <- nao_me %>% 
            mutate(genero = get_gender(nome_socio), .after = nome_socio) %>% 
            filter(data_inicio_atividade == entrada_sociedade) %>% # sócios da entrada
            select(-`...1`) %>% 
            mutate(data = parse_date_time(data_inicio_atividade, orders = "ymd"),
            ano = year(data))

dim(nao_me_tratado)
```

Em sequência, foi aplicada a função `get_gender` para fazer as previsões. O algoritmo conseguiu prever 91,6% dos sexos. Com isso, o número de observações foi de 214.601 observações. 

Considerando o total inicial de 684.096, mantivemos 601.946 observações (87% das observações) 

```{r}
nao_me_tratado_s_na <- nao_me_tratado %>% 
                      filter(genero != "NA")

dim(nao_me_tratado_s_na)
```

Os resultados calculados para o total de empresas não ME por sexo e município estão na tabela abaixo. 

```{r}
municipios_nao_me <- nao_me_tratado_s_na %>% 
                      left_join(municipios, by = c("municipio"="Codigo_TOM_SERPRO")) %>% 
                      rename(nome_municipio = Municipio) %>% 
                      group_by(municipio,nome_municipio,genero) %>% 
                      count() %>% 
                      mutate(natureza = "não me")

DT::datatable(municipios_nao_me)
```

## 3) Todas empresas 

```{r}
total <- rbind(municipios_me, municipios_nao_me)

total <- total %>% 
          group_by(nome_municipio, genero) %>% 
          summarise(total = sum(n))

DT::datatable(total)
```






